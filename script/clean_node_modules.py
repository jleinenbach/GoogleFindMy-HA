"""Remove repository-local ``node_modules`` directories before running string scans.

This helper deletes ``node_modules`` (defaults to the repo root) to avoid pulling
third-party fixture content into repository-wide string searches or linters.
"""

from __future__ import annotations

import argparse
import shutil
from pathlib import Path

_REPO_ROOT = Path(__file__).resolve().parent.parent
_DEFAULT_TARGET = _REPO_ROOT / "node_modules"


def _parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(
        description=(
            "Prune node_modules to keep string scans focused on the integration code. "
            "Defaults to the repo root node_modules directory."
        )
    )
    parser.add_argument(
        "path",
        nargs="?",
        type=Path,
        default=_DEFAULT_TARGET,
        help=f"Node modules directory to remove (default: {_DEFAULT_TARGET}).",
    )
    parser.add_argument(
        "--dry-run",
        action="store_true",
        help="Report the target directory without removing it.",
    )
    return parser.parse_args()


def _resolve_target(path: Path) -> Path:
    if path.is_absolute():
        return path
    return (_REPO_ROOT / path).resolve()


def main() -> int:
    args = _parse_args()
    target = _resolve_target(args.path)

    if not target.exists():
        print(f"No node_modules directory present at {target}; nothing to clean.")
        return 0

    if not target.is_dir():
        print(f"Refusing to remove non-directory path: {target}")
        return 1

    if args.dry_run:
        print(f"[dry-run] Would remove {target}")
        return 0

    shutil.rmtree(target)
    print(f"Removed {target}")
    return 0


if __name__ == "__main__":
    raise SystemExit(main())
